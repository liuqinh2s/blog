---
title: mysql存储过程
categories: [数据库, mysql]
comments: true
---

## 基本概念

1. 什么是存储例程？

    存储例程是一组sql语句，通过在查询中调用一个指定的名称来执行这些sql语句命令。

2. 为什么要使用存储例程？

    有时候我们的服务同时有web版，桌面版，移动版，他们都和数据库进行交互来完成数据的存取工作。现在要修改其中一个查询sql语句，那么我们可能要同时修改他们中对应的查询sql语句，这是一种重复劳动！另外把sql语句放在web或桌面程序中很容易遭到sql注入攻击破坏。而存储例程正好可以帮助我们解决这个问题。

3. 存储过程（stored procedure）、存储例程（stored routine）和存储函数的区别？

    Mysql存储例程实际上包括了存储过程和存储函数，它们被统称为存储例程。其中存储过程主要完成select、insert、delete、update等工作，而存储函数只完成select工作。

## 语法

### 基本结构

创建存储过程和存储函数：

```mysql
create procedure 存储过程名 (参数)
create function 存储函数名 (参数)
```

一个完整的存储过程例子如下：

```mysql
DELIMITER //
CREATE PROCEDURE 存储过程名(OUT s int)
BEGIN
SELECT COUNT(*) INTO s FROM user;
END //
DELIMITER ;
```

语法解析：

1. 这里需要注意的是`DELIMITER //`和`DELIMITER ;`两句，`DELIMITER`是分隔符的意思，因为mysql默认以`;`为分隔符，如果我们没有声明分隔符，那么编译器会把存储过程当成SQL语句处理，存储过程的编译就会报错，所以要事先用`DELIMITER`关键字声明当前分隔符，这样MySQL才会将`;`当做存储过程中的代码，不会执行这些代码。**最后用完之后要把分隔符还原**。知道了这语法的意思，你就会知道，为啥有的时候有人代码写成：`DELIMITER $$`，因为分隔符完全可以自己设定啊，唯一要担心的就是与关键字冲突。`//`在mysql里面并不是注释符，mysql的注释符是`--`。
2. 存储过程有三种类型的参数：`IN`、`OUT`、`INOUT`，顾名思义，`IN`类型的参数只能用作输入，`OUT`类型的参数只能用作输出，`INOUT`类型的参数可以输入输出。
3. 过程体的开始和结束使用`BEGIN`和`END`标识。

### 变量

#### 定义

局部变量定义一定要放在存储过程体的开始

`DECLARE variable_name [,variable_name...] datatype [DEFAULT value];`

其中`datatype`为MySQL的数据类型，例如：int、float、varchar、date

例如：

```mysql
DECLARE l_int int unsigned default 4000000;
DECLARE l_numeric number(8,2) DEFAULT 9.95;
DECLARE l_date date DEFAULT '1997-12-31';
DECLARE l_datetime datetime DEFAULT '1997-12-31 23:59:59'
DECLARE l_varchar varchar DEFAULT 'This will not be padded'
```

#### 赋值

`SET  变量名=表达式值[,variable_name=expression...];`

用户变量名以@开头

#### 注释

- 单行注释：`--`
- 多行注释：`/**/`

## 存储过程的查询

我们想知道一个数据库下有哪些表，可以用`show tables;`进行查看，那么我们要想看某个数据库下有哪些存储过程，用什么命令呢？

`show procedure status where db="数据库名";`

db这个名字是不能改的。

如果想知道详细的存储过程，是不是也可以像操作表一样用`describe 表名;`进行查看呢？

`show create procedure 数据库.存储过程名;`

