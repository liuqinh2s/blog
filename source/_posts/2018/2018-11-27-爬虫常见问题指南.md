---
title: 爬虫常见问题指南
categories: [项目]
tags: [Python]
comments: true
---

## 读写文件遇到的问题

### 编码问题

读写文件一般遇到的就是编码问题了

```python
f = open("tm_shop.txt","r")
gg = f.readlines()
f.close()
```

```
UnicodeDecodeError: 'gbk' codec can't decode byte 0x97 in position 96: illegal multibyte sequence
```

decode是解码的意思，也就是说系统使用`gbk`来解码这个文件，发现出错了。而这个文件实际上是`utf-8`编码。那么我们可以指明该文件的编码，让系统知道这是一个`utf-8`编码的文件。另一种做法则是把系统的默认解码方式改为：`utf-8`。

1. 指明文件的编码

```python
f = open("tm_shop.txt","r",encoding="utf-8")
gg = f.readlines()
f.close()
```

2. 修改系统的默认解码方式

因为解码是python自动进行的，我们没有指明解码方式，python2 就会使用 sys.defaultencoding 指明的方式来解码。很多情况下 sys.defaultencoding 是 
ANSCII，如果文件或字符串不是这个类型就会出错。

但我这里遇到一个奇怪的问题，我的`sys.getdefaultencoding()`得到的结果是utf-8，但解码文件的时候却使用gbk去解码。

Python2.x如果不指定编码格式，默认的编码是ascii，不进行转换会出现“UnicodeDecodeError: 'ascii' codec can't decode byte ......”样子的错误。

Python3.x中已经修改了编码的方式，明确了str和byte的区分，不需要使用这个转换了。
如果硬要用reload，需要import importlib
多说一句，Python3.x中sys没有setdefaultencoding了，因为不需要。

在Python2.x中由于str和byte之间没有明显区别，经常要依赖于defaultencoding来做转换。
在python3中有了明确的str和byte类型区别，从一种类型转换成另一种类型要显式指定encoding。

https://windard.com/blog/2017/05/14/Python-Encode-And-Decode

这个问题我到最后都没有解决，所以还是老老实实用第一种方法吧，指明文件的编码。

## BeautifulSoup 获取一类属性中的所有值

`https://www.amazon.cn/s/ref=nb_sb_noss_1?__mk_zh_CN=%E4%BA%9A%E9%A9%AC%E9%80%8A%E7%BD%91%E7%AB%99&url=search-alias%3Daps&field-keywords=%E8%BF%9E%E8%A1%A3%E8%A3%99`

抽取出上面那个页面中所有`data-asin`属性的值。代码如下：

```python
# coding=utf-8
import requests
import re
from bs4 import BeautifulSoup

header = {
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36"
}

response = requests.get(
    "https://www.amazon.cn/s/ref=nb_sb_noss_1?__mk_zh_CN=%E4%BA%9A%E9%A9%AC%E9%80%8A%E7%BD%91%E7%AB%99&url=search-alias%3Daps&field-keywords=%E8%BF%9E%E8%A1%A3%E8%A3%99",
    headers=header)

soup = BeautifulSoup(response._content, "lxml")
# print(soup)
data_regexp = re.compile('data-asin=\".*?\"')
# data = soup.find_all(text=data_regexp)
data = soup.find_all("li", attrs={"class":"celwidget"})
# print(data)
for x in data:
    print(x.attrs['data-asin'])
```

最蛋疼的点在于我们不能直接使用`data-asin`属性去获取值，BeautifulSoup提供给我们的方法只有`attrs={'data-asin': 'B0193B0H4A'}`这种，而我们现在就是要获取里面的值，也就是说我们不知道值是什么。我最后是把整个包含`data-asin`的标签抽取出来了，然后获取它里面的属性。